%% ECG Signal Quality Measures
%% Date : 05/01/2024

%% 
% Loading Data
prefix = '/media/shrey/Kirti1/Data_and_Analysis/Resting_MEG_RawTimeSeries/CC';
suffix = '/transdef_mf2pt2_rest_raw.fif';

subjects = [110033;110037;110045;110056;110069;110087;110098;110101;110126;110174;110182;110187;110319;110411;110606;112141;120008;120049;120061;120065;120120;120137;120166;120182;120184;120208;120212;120218;120264;120276;120309;120313;120319;120347;120376;120409;120462;120469;120470;120550;120640;120727;120764;120795;121106;121111;121144;121158;121200;121317;121397;121411;121428;121479;121685;121795;122016;122172;122405;122620;210023;210051;210088;210124;210148;210172;210174;210182;210250;210314;210422;210519;210526;210617;210657;212153;220098;220107;220115;220132;220151;220198;220203;220223;220232;220234;220284;220323;220335;220352;220372;220419;220506;220511;220518;220519;220526;220535;220567;220610;220635;220697;220713;220828;220843;220901;220920;220974;220999;221002;221031;221033;221040;221054;221107;221209;221220;221244;221324;221336;221352;221373;221487;221511;221527;221565;221585;221595;221648;221733;221737;221740;221755;221775;221828;221886;221935;221954;221977;221980;222120;222125;222185;222258;222264;222304;222326;222367;222496;222555;222652;222797;222956;223085;223115;223286;310008;310051;310052;310086;310129;310135;310142;310203;310214;310224;310252;310256;310331;310361;310385;310391;310397;310400;310410;310414;310450;310463;310473;312058;312149;312222;320002;320022;320059;320088;320089;320107;320109;320160;320202;320206;320218;320267;320297;320321;320325;320336;320342;320359;320361;320379;320417;320428;320429;320445;320448;320461;320478;320500;320553;320568;320574;320575;320576;320608;320616;320621;320636;320651;320661;320680;320686;320687;320698;320759;320776;320814;320850;320861;320870;320888;320893;320904;321000;321025;321053;321069;321073;321087;321107;321137;321154;321174;321203;321281;321291;321331;321368;321428;321431;321464;321504;321506;321529;321544;321557;321585;321594;321595;321880;321899;321976;322186;410015;410032;410040;410084;410086;410091;410094;410097;410101;410113;410119;410121;410129;410169;410173;410177;410179;410182;410220;410222;410226;410243;410248;410251;410284;410286;410287;410289;410297;410323;410325;410354;410387;410390;410432;412004;412021;420004;420060;420061;420071;420075;420089;420091;420094;420100;420137;420143;420148;420149;420157;420162;420167;420173;420180;420182;420197;420198;420202;420204;420217;420222;420226;420229;420231;420236;420241;420244;420260;420261;420286;420322;420324;420348;420356;420364;420383;420392;420396;420402;420412;420433;420435;420454;420462;420464;420493;420566;420582;420587;420589;420623;420720;420776;420888;510039;510043;510050;510076;510086;510115;510161;510163;510208;510220;510226;510237;510242;510243;510255;510256;510258;510259;510284;510304;510321;510323;510329;510342;510354;510355;510392;510393;510395;510415;510433;510434;510438;510473;510474;510480;510483;510486;510534;510548;510551;510609;510629;510639;510648;512003;520002;520011;520013;520042;520053;520055;520065;520078;520083;520097;520122;520127;520134;520136;520147;520168;520175;520197;520200;520209;520211;520215;520239;520247;520253;520254;520279;520287;520377;520390;520391;520395;520398;520424;520436;520477;520480;520503;520517;520552;520560;520562;520584;520585;520597;520607;520624;520673;520745;520775;520868;520980;521040;610022;610028;610039;610040;610046;610051;610052;610058;610071;610076;610099;610101;610146;610178;610210;610212;610227;610285;610288;610292;610308;610344;610372;610392;610405;610462;610469;610496;610508;610568;610575;610576;610594;610625;610631;610653;610658;610671;620005;620026;620073;620085;620090;620106;620114;620118;620121;620129;620152;620164;620193;620259;620262;620264;620279;620284;620314;620354;620359;620405;620406;620413;620429;620436;620444;620451;620454;620466;620479;620490;620496;620515;620518;620526;620527;620549;620567;620572;620592;620610;620619;620659;620685;620720;620785;620793;620821;620885;620919;620935;621011;621080;621118;621128;621184;621199;621248;621284;621642;710037;710131;710176;710214;710223;710313;710342;710350;710382;710429;710446;710462;710486;710494;710548;710551;710566;710591;710664;710679;710858;710982;711027;711128;711158;711244;711245;712027;720023;720119;720188;720238;720290;720304;720329;720330;720358;720400;720407;720497;720511;720516;720622;720646;720670;720685;720723;720774;720941;720986;721052;721107;721114;721224;721291;721292;721374;721377;721392;721418;721434;721449;721504;721532;721585;721648;721704;721707;721729;721888;721891;721894;722421;722536;722542;722651;722891;723197;723395];


for ii = 1:length(subjects)
    addpath(genpath('/home/shrey/Old_stuff/Previous Stuff/Softwares/fieldtrip-20171231')); %add fieldtrip    
%% 1) Power Spectrum Distribution of QRS wave (pSQI)
        
    %Loading the raw data
    data = ft_read_data(strcat(prefix, num2str(subjects(ii,1)), suffix));
  
    %Extracting out ECG time series
    ecg = -1 * data(323,:);
    
    %Energy of the QRS wave
    params_qrs.Fs = 1000;
    params_qrs.fpass = [5 15];
    params_qrs.tapers = [3 5];
    
    rmpath(genpath('/home/shrey/Old_stuff/Previous Stuff/Softwares/fieldtrip-20171231')); %add fieldtrip
    addpath(genpath('/home/shrey/Old_stuff/Previous Stuff/Softwares/chronux_2_12'));  
    
    [S_qrs,f_qrs] = mtspectrumc(ecg,params_qrs);
    
    %Energy of the total ECG 
    
    params_total.Fs = 1000;
    params_total.fpass = [5 40];
    params_total.tapers = [3 5];
    
    [S_total,f_total] = mtspectrumc(ecg,params_total);
    
    % Calculating pSQI 
    pSQI{ii} = sum(S_qrs)./sum(S_total);
    
    %% 2) Variability in the R-R Interval cSQI
    load('/media/shrey/Kirti1/Data_and_Analysis/January_2023_HEP_project/locs.mat');
    RR_interval = locs{1, ii}(1,2:end) - locs{1, ii}(1,1:end-1);   
    mean_RR{ii} = mean(RR_interval);
    std_RR{ii} = std(RR_interval);
    
    cSQI{ii} = std_RR{1,ii}./mean_RR{1,ii};
    
    %% 3) Skewness sSQI and Kurtosis kSQI
    sSQI{ii} = skewness(ecg);
    kSQI{ii} = kurtosis(ecg);
    
    %% 4) The Relative Power in the Baseline basSQI
    params_nums.Fs = 1000;
    params_num.fpass = [0 1];
    params_num.tapers = [3 5];
    [S_num, f_num] = mtspectrumc(ecg, params_num);
    
    params_deno.Fs = 1000;
    params_deno.fpass = [0 40];
    params_deno.tapers = [3 5];
    [S_deno, f_deno] = mtspectrumc(ecg, params_deno);
    
    basSQI1 = 1-sum(S_num);
    basSQI{ii} = basSQI1./sum(S_deno);

%% Saving variables
    cd('/media/shrey/Kirti1/CuratedCodes_Project1_July2024')
    save pSQI pSQI
    save cSQI cSQI
    save sSQI sSQI
    save kSQI kSQI
    save basSQI basSQI
    
    ii   
    
end